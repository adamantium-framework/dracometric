{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"DRACO METRIC","text":"<p>High-performance WireGuard VPN server aggregator API.</p> <p>DRACO METRIC is a security-hardened REST API built with FastAPI that aggregates VPN server data from multiple providers into a unified format. It fetches, normalizes, caches, and serves WireGuard-compatible server information from NordVPN and Surfshark through a single consistent interface.</p>"},{"location":"#what-it-does","title":"What It Does","text":"<ul> <li>Fetches VPN server data from NordVPN and Surfshark APIs</li> <li>Filters for WireGuard-compatible servers only</li> <li>Returns only online servers (verified at both server and technology level)</li> <li>Provides real-time latency measurement via fping or TCP connect</li> <li>Normalizes all provider data into a canonical format</li> <li>Caches results with configurable TTL for performance</li> <li>Serves data through a paginated, filterable REST API</li> </ul>"},{"location":"#key-features","title":"Key Features","text":"Feature Description Multi-provider NordVPN and Surfshark with unified schema WireGuard only Filters servers that support WireGuard UDP Online filtering Excludes offline servers and offline WireGuard endpoints Latency measurement Measures real network latency via fping or TCP Pagination All list endpoints support page/page_size parameters Caching In-memory async cache with configurable TTL (default: 5 min) Rate limiting Sliding window per-IP rate limiter with standard headers API key auth Optional timing-safe API key authentication Security headers HSTS, CSP, X-Frame-Options, and more HTTP/2 Upstream requests use HTTP/2 for performance GZip compression Automatic response compression JSON performance Uses orjson for fast serialization"},{"location":"#supported-providers","title":"Supported Providers","text":"Provider Server Load Online Status WireGuard Filter NordVPN Yes (0-100%) Yes (server + technology level) API query filter + local validation Surfshark Yes (0-100%) Implicit (API only returns online) Local type filter (wireguard/generic)"},{"location":"#tech-stack","title":"Tech Stack","text":"<ul> <li>Python 3.13+ with async/await</li> <li>FastAPI with Pydantic v2 validation</li> <li>httpx with HTTP/2 and connection pooling</li> <li>aiocache for async in-memory caching</li> <li>orjson for high-performance JSON serialization</li> <li>uvicorn ASGI server</li> </ul>"},{"location":"#license","title":"License","text":"<p>BSD 3-Clause License. See LICENSE.</p> <p>Copyright (c) 2026, Guilherme Hakme - Adamantium Security.</p>"},{"location":"api-reference/","title":"API Reference","text":"<p>Base URL: <code>http://localhost:8000</code> (development) or your production domain.</p> <p>All API endpoints are prefixed with <code>/api</code>. The <code>{provider}</code> path parameter accepts <code>nordvpn</code> or <code>surfshark</code>.</p> <p>Authentication</p> <p>When <code>ENABLE_API_KEY_AUTH=true</code>, all <code>/api/*</code> endpoints require the <code>X-API-Key</code> header. The <code>/health</code> endpoint is always public.</p>"},{"location":"api-reference/#health-check","title":"Health Check","text":""},{"location":"api-reference/#get-health","title":"<code>GET /health</code>","text":"<p>Lightweight health check for load balancers and monitoring. Always public (no auth required, no rate limiting).</p> <p>Response <code>200 OK</code></p> <pre><code>{\n  \"status\": \"healthy\",\n  \"version\": \"1.0.0\"\n}\n</code></pre>"},{"location":"api-reference/#server-discovery","title":"Server Discovery","text":""},{"location":"api-reference/#get-apiproviderservers","title":"<code>GET /api/{provider}/servers</code>","text":"<p>Retrieves all available VPN servers for a provider with optional pagination.</p> <p>Path Parameters</p> Parameter Type Required Description <code>provider</code> string Yes <code>nordvpn</code> or <code>surfshark</code> <p>Query Parameters</p> Parameter Type Default Range Description <code>page</code> integer <code>1</code> &gt;= 1 Page number (1-indexed) <code>page_size</code> integer <code>100</code> 1 - 1000 Results per page <p>Response <code>200 OK</code> \u2014 <code>List[VPNServer]</code></p> <pre><code>[\n  {\n    \"provider\": \"nordvpn\",\n    \"country\": \"United States\",\n    \"country_code\": \"US\",\n    \"identifier\": \"us1234.nordvpn.com\",\n    \"public_key\": \"abc123def456...\",\n    \"load\": 25,\n    \"latency\": null\n  }\n]\n</code></pre> <p>Notes</p> <ul> <li>NordVPN servers are sorted by load (lowest first)</li> <li>Surfshark servers are returned in API order</li> <li>Only online servers with active WireGuard support are returned</li> </ul>"},{"location":"api-reference/#get-apiproviderserverspaginated","title":"<code>GET /api/{provider}/servers/paginated</code>","text":"<p>Same as above but returns pagination metadata alongside the data.</p> <p>Query Parameters</p> Parameter Type Default Range Description <code>page</code> integer <code>1</code> &gt;= 1 Page number (1-indexed) <code>page_size</code> integer <code>100</code> 1 - 1000 Results per page <p>Response <code>200 OK</code> \u2014 <code>PaginatedResponse</code></p> <pre><code>{\n  \"total\": 5432,\n  \"page\": 1,\n  \"page_size\": 100,\n  \"total_pages\": 55,\n  \"data\": [\n    {\n      \"provider\": \"nordvpn\",\n      \"country\": \"United States\",\n      \"country_code\": \"US\",\n      \"identifier\": \"us1234.nordvpn.com\",\n      \"public_key\": \"abc123def456...\",\n      \"load\": 25,\n      \"latency\": null\n    }\n  ]\n}\n</code></pre> <p>Error <code>404 Not Found</code> \u2014 Page number exceeds total pages.</p>"},{"location":"api-reference/#get-apiproviderserverscountry_code","title":"<code>GET /api/{provider}/servers/{country_code}</code>","text":"<p>Retrieves servers for a specific country.</p> <p>Path Parameters</p> Parameter Type Required Pattern Description <code>provider</code> string Yes <code>nordvpn\\|surfshark</code> VPN provider <code>country_code</code> string Yes <code>^[A-Z]{2}$</code> ISO 3166-1 alpha-2 code <p>Query Parameters</p> Parameter Type Default Range Description <code>page</code> integer <code>1</code> &gt;= 1 Page number <code>page_size</code> integer <code>100</code> 1 - 1000 Results per page <p>Response <code>200 OK</code> \u2014 <code>List[VPNServer]</code></p> <p>Error <code>404 Not Found</code> \u2014 No servers found for the specified country.</p> <p>Example</p> <pre><code>curl http://localhost:8000/api/nordvpn/servers/BR\n</code></pre>"},{"location":"api-reference/#performance","title":"Performance","text":""},{"location":"api-reference/#get-apiproviderserverstop","title":"<code>GET /api/{provider}/servers/top</code>","text":"<p>Returns the top-performing servers ranked by latency (if available) then by load.</p> <p>Query Parameters</p> Parameter Type Default Range Description <code>limit</code> integer <code>10</code> 1 - 50 Number of servers to return <code>country_code</code> string null <code>^[A-Z]{2}$</code> Optional country filter <p>Response <code>200 OK</code> \u2014 <code>List[VPNServer]</code></p> <p>Servers are sorted by:</p> <ol> <li>Latency (if measured) \u2014 lower is better</li> <li>Load (fallback) \u2014 lower is better</li> </ol> <p>Error <code>404 Not Found</code> \u2014 No servers found for the specified country.</p> <p>Example</p> <pre><code># Top 5 servers globally\ncurl http://localhost:8000/api/nordvpn/servers/top?limit=5\n\n# Top 10 in Germany\ncurl http://localhost:8000/api/nordvpn/servers/top?limit=10&amp;country_code=DE\n</code></pre>"},{"location":"api-reference/#get-apiproviderserverslatency","title":"<code>GET /api/{provider}/servers/latency</code>","text":"<p>Measures actual network latency to VPN servers and returns detailed results.</p> <p>Query Parameters</p> Parameter Type Default Range Description <code>country_code</code> string null <code>^[A-Z]{2}$</code> Optional country filter <code>limit</code> integer <code>0</code> 0 - 5000 Max servers to measure (0 = all) <code>method</code> string <code>auto</code> <code>auto\\|fping\\|tcp</code> Measurement method <p>Measurement Methods</p> Method Speed Requirements How It Works <code>auto</code> Fastest available None Uses fping if installed, else TCP <code>fping</code> ~2-5s / 100 servers fping binary ICMP ping via external command <code>tcp</code> ~10-30s / 100 servers None TCP connect to port 51820, fallback to 443/80/22 <p>Response <code>200 OK</code> \u2014 <code>LatencyMeasurementResponse</code></p> <pre><code>{\n  \"total_servers\": 150,\n  \"measured\": 150,\n  \"successful\": 142,\n  \"failed\": 8,\n  \"method\": \"fping\",\n  \"servers\": [\n    {\n      \"provider\": \"nordvpn\",\n      \"country\": \"United States\",\n      \"country_code\": \"US\",\n      \"identifier\": \"us1234.nordvpn.com\",\n      \"public_key\": \"abc123def456...\",\n      \"load\": 25,\n      \"latency\": 12.45\n    }\n  ]\n}\n</code></pre> <p>Results are sorted by latency (lowest first). Servers that could not be reached have <code>latency: null</code> and appear at the end.</p>"},{"location":"api-reference/#get-apiproviderserversfastest","title":"<code>GET /api/{provider}/servers/fastest</code>","text":"<p>Measures latency and returns only the fastest servers. This is the recommended endpoint for finding optimal servers.</p> <p>Query Parameters</p> Parameter Type Default Range Description <code>limit</code> integer <code>10</code> 1 - 50 Number of fastest servers to return <code>country_code</code> string null <code>^[A-Z]{2}$</code> Include only this country <code>measure_count</code> integer <code>0</code> 0 - 5000 Servers to measure (0 = all) <code>exclude</code> string null e.g. <code>BR-US-DE</code> Exclude countries (hyphen-separated) <p>Response <code>200 OK</code> \u2014 <code>List[VPNServer]</code></p> <p>All returned servers have a non-null <code>latency</code> value and are sorted lowest-first.</p> <p>Error Responses</p> Status Condition <code>404</code> No servers found after filtering <code>503</code> Could not reach any servers <p>Examples</p> <pre><code># 10 fastest servers globally\ncurl http://localhost:8000/api/nordvpn/servers/fastest\n\n# 5 fastest in Japan\ncurl http://localhost:8000/api/nordvpn/servers/fastest?limit=5&amp;country_code=JP\n\n# 10 fastest excluding Brazil and US\ncurl http://localhost:8000/api/nordvpn/servers/fastest?exclude=BR-US\n\n# Measure only 100 servers for faster response\ncurl http://localhost:8000/api/nordvpn/servers/fastest?measure_count=100\n</code></pre>"},{"location":"api-reference/#metadata","title":"Metadata","text":""},{"location":"api-reference/#get-apiprovidercountries","title":"<code>GET /api/{provider}/countries</code>","text":"<p>Returns a list of all countries that have available servers for the specified provider.</p> <p>Response <code>200 OK</code> \u2014 <code>List[CountryInfo]</code></p> <pre><code>[\n  {\n    \"code\": \"BR\",\n    \"name\": \"Brazil\",\n    \"display\": \"BR - Brazil\"\n  },\n  {\n    \"code\": \"US\",\n    \"name\": \"United States\",\n    \"display\": \"US - United States\"\n  }\n]\n</code></pre> <p>Results are sorted alphabetically by country code.</p>"},{"location":"api-reference/#data-models","title":"Data Models","text":""},{"location":"api-reference/#vpnserver","title":"VPNServer","text":"Field Type Required Description <code>provider</code> <code>\"nordvpn\"</code> | <code>\"surfshark\"</code> Yes VPN provider name <code>country</code> string Yes Full country name <code>country_code</code> string (2 chars) Yes ISO 3166-1 alpha-2 code <code>identifier</code> string Yes Server hostname (e.g., <code>us1234.nordvpn.com</code>) <code>public_key</code> string Yes WireGuard public key <code>load</code> integer | null No Server load percentage (0-100) <code>latency</code> float | null No Measured latency in milliseconds"},{"location":"api-reference/#countryinfo","title":"CountryInfo","text":"Field Type Description <code>code</code> string (2 chars) ISO 3166-1 alpha-2 code <code>name</code> string Full country name <code>display</code> string Formatted as <code>\"CODE - Name\"</code>"},{"location":"api-reference/#paginatedresponse","title":"PaginatedResponse","text":"Field Type Description <code>total</code> integer Total number of servers <code>page</code> integer Current page number <code>page_size</code> integer Items per page <code>total_pages</code> integer Total number of pages <code>data</code> List[VPNServer] Server data for current page"},{"location":"api-reference/#latencymeasurementresponse","title":"LatencyMeasurementResponse","text":"Field Type Description <code>total_servers</code> integer Total servers measured <code>measured</code> integer Number of servers measured <code>successful</code> integer Servers that responded <code>failed</code> integer Servers that did not respond <code>method</code> string Measurement method used (<code>fping</code> or <code>tcp</code>) <code>servers</code> List[VPNServer] Servers with latency data, sorted lowest first"},{"location":"api-reference/#error-responses","title":"Error Responses","text":"<p>All errors follow a consistent format:</p> <pre><code>{\n  \"error\": \"Error Type\",\n  \"message\": \"Human-readable description.\"\n}\n</code></pre>"},{"location":"api-reference/#status-codes","title":"Status Codes","text":"Code Meaning When <code>200</code> Success Request completed successfully <code>401</code> Unauthorized Missing API key (when auth is enabled) <code>403</code> Forbidden Invalid API key <code>404</code> Not Found Country/provider not found, page out of range <code>422</code> Validation Error Invalid query parameters or path values <code>429</code> Too Many Requests Rate limit exceeded <code>500</code> Internal Server Error Unexpected server error <code>503</code> Service Unavailable External VPN API is unreachable"},{"location":"api-reference/#rate-limit-headers","title":"Rate Limit Headers","text":"<p>Every response (except <code>/health</code>) includes rate limit headers:</p> Header Description <code>X-RateLimit-Limit</code> Maximum requests per window <code>X-RateLimit-Remaining</code> Requests remaining in current window <code>X-RateLimit-Reset</code> Unix epoch timestamp when the window resets <code>Retry-After</code> Seconds to wait (only on 429 responses)"},{"location":"api-reference/#interactive-documentation","title":"Interactive Documentation","text":"<p>When <code>DEBUG=true</code>, the API serves interactive documentation:</p> URL Interface <code>/docs</code> Swagger UI \u2014 interactive, try requests in-browser <code>/redoc</code> ReDoc \u2014 clean reference documentation <code>/openapi.json</code> Raw OpenAPI 3.x specification <p>Warning</p> <p>These endpoints are disabled in production (<code>DEBUG=false</code>) to prevent information disclosure.</p>"},{"location":"architecture/","title":"Architecture","text":"<p>Technical architecture of DRACO METRIC, covering the application layers, data flow, and design decisions.</p>"},{"location":"architecture/#high-level-overview","title":"High-Level Overview","text":"<pre><code>                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                          \u2502              Reverse Proxy                  \u2502\n                          \u2502        (TLS termination, nginx/Caddy)       \u2502\n                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                             \u2502 HTTP :8000\n                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                          \u2502              DRACO METRIC                   \u2502\n                          \u2502                                             \u2502\n                          \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n                          \u2502  \u2502Rate Limit \u2502\u2192 \u2502 API Key  \u2502\u2192 \u2502  CORS   \u2502  \u2502\n                          \u2502  \u2502Middleware \u2502  \u2502  Auth    \u2502  \u2502Middleware\u2502  \u2502\n                          \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                          \u2502                      \u2502                      \u2502\n                          \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n                          \u2502  \u2502           Router Layer               \u2502   \u2502\n                          \u2502  \u2502        (FastAPI endpoints)           \u2502   \u2502\n                          \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n                          \u2502                      \u2502                      \u2502\n                          \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n                          \u2502  \u2502          Service Layer               \u2502   \u2502\n                          \u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502   \u2502\n                          \u2502  \u2502  \u2502 NordVPN  \u2502  \u2502    Surfshark     \u2502  \u2502   \u2502\n                          \u2502  \u2502  \u2502 Service  \u2502  \u2502    Service       \u2502  \u2502   \u2502\n                          \u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502   \u2502\n                          \u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502   \u2502\n                          \u2502  \u2502  \u2502      Latency Service         \u2502    \u2502   \u2502\n                          \u2502  \u2502  \u2502  (fping / TCP connect)       \u2502    \u2502   \u2502\n                          \u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502   \u2502\n                          \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n                          \u2502                      \u2502                      \u2502\n                          \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n                          \u2502  \u2502          Infrastructure              \u2502   \u2502\n                          \u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502   \u2502\n                          \u2502  \u2502  \u2502  Cache   \u2502  \u2502   HTTP Client    \u2502  \u2502   \u2502\n                          \u2502  \u2502  \u2502(aiocache)\u2502  \u2502  (httpx/HTTP2)   \u2502  \u2502   \u2502\n                          \u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502   \u2502\n                          \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                             \u2502\n                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                          \u2502           Upstream VPN APIs                 \u2502\n                          \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n                          \u2502  \u2502 NordVPN API  \u2502  \u2502  Surfshark API     \u2502   \u2502\n                          \u2502  \u2502  /v1/servers \u2502  \u2502 /v3/server/clusters\u2502   \u2502\n                          \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#project-structure","title":"Project Structure","text":"<pre><code>app/\n\u251c\u2500\u2500 main.py                     # Application entry point, middleware stack, exception handlers\n\u251c\u2500\u2500 settings.py                 # Pydantic-based configuration (env vars)\n\u251c\u2500\u2500 models/\n\u2502   \u2514\u2500\u2500 vpn.py                  # Canonical data models (VPNServer, CountryInfo)\n\u251c\u2500\u2500 routers/\n\u2502   \u2514\u2500\u2500 vpn.py                  # API endpoints with dependency injection\n\u251c\u2500\u2500 middleware/\n\u2502   \u251c\u2500\u2500 __init__.py             # Middleware exports\n\u2502   \u251c\u2500\u2500 auth.py                 # API key authentication middleware\n\u2502   \u2514\u2500\u2500 rate_limit.py           # Sliding window rate limiter\n\u2514\u2500\u2500 services/\n    \u251c\u2500\u2500 vpn_service.py          # Abstract base class + HTTP client management\n    \u251c\u2500\u2500 nordvpn_service.py      # NordVPN API integration\n    \u251c\u2500\u2500 surfshark_service.py    # Surfshark API integration\n    \u2514\u2500\u2500 latency_service.py      # Network latency measurement (fping/TCP)\n</code></pre>"},{"location":"architecture/#application-layers","title":"Application Layers","text":""},{"location":"architecture/#1-middleware-stack","title":"1. Middleware Stack","text":"<p>Middleware executes in a specific order. In FastAPI, the last middleware added is the first to execute on incoming requests:</p> <pre><code>Request \u2192 Rate Limit \u2192 API Key Auth \u2192 CORS \u2192 Security Headers \u2192 GZip \u2192 Router\n                                                                          \u2502\nResponse \u2190 Rate Limit \u2190 API Key Auth \u2190 CORS \u2190 Security Headers \u2190 GZip \u2190\u2500\u2518\n</code></pre> Order Middleware Purpose 1st (outermost) Rate Limiter Reject excessive requests before any processing 2nd API Key Auth Authenticate requests via <code>X-API-Key</code> header 3rd CORS Handle cross-origin preflight and response headers 4th Security Headers Add <code>X-Frame-Options</code>, <code>HSTS</code>, <code>CSP</code>, etc. 5th (innermost) GZip Compress responses larger than 500 bytes <p>Each middleware can short-circuit the request (e.g., rate limiter returns <code>429</code> without reaching the router).</p>"},{"location":"architecture/#2-router-layer","title":"2. Router Layer","text":"<p>A single router (<code>/api</code>) handles all VPN endpoints using FastAPI's dependency injection:</p> <pre><code># The provider is resolved via path parameter dependency\n@router.get(\"/{provider}/servers\")\nasync def get_servers(service = Depends(get_vpn_service)):\n    return await service.get_servers()\n</code></pre> <p>The <code>get_vpn_service</code> dependency resolves <code>{provider}</code> (\"nordvpn\" or \"surfshark\") to the appropriate service singleton. This pattern allows adding new providers without modifying existing endpoints.</p> <p>Route ordering matters \u2014 specific routes (<code>/servers/top</code>, <code>/servers/latency</code>, <code>/servers/fastest</code>) are registered before the parameterized route (<code>/servers/{country_code}</code>) to avoid path conflicts.</p>"},{"location":"architecture/#3-service-layer","title":"3. Service Layer","text":"<p>Services follow the Abstract Factory pattern:</p> <pre><code>AbstractVPNService (ABC)\n\u251c\u2500\u2500 get_servers() \u2192 List[VPNServer]\n\u2514\u2500\u2500 get_servers_by_country(code) \u2192 List[VPNServer]\n\nNordVPNService(AbstractVPNService)\n\u251c\u2500\u2500 Fetches from NordVPN API\n\u251c\u2500\u2500 Filters: status == \"online\", WireGuard pivot.status == \"online\"\n\u251c\u2500\u2500 Extracts WireGuard public key from technology metadata\n\u2514\u2500\u2500 Sorts by load (lowest first)\n\nSurfsharkService(AbstractVPNService)\n\u251c\u2500\u2500 Fetches from Surfshark API\n\u251c\u2500\u2500 Filters: type in [\"wireguard\", \"generic\"] with pubKey\n\u251c\u2500\u2500 No explicit status field (API only returns available servers)\n\u2514\u2500\u2500 Returns in API order\n\nLatencyService\n\u251c\u2500\u2500 measure_servers_latency() \u2192 List[VPNServer] (with latency populated)\n\u251c\u2500\u2500 fping: Bulk ICMP via external command (fastest, batched in groups of 500)\n\u2514\u2500\u2500 TCP: Async connection to port 51820 with fallback to 443/80/22\n</code></pre> <p>All service instances are singletons managed by the router's dependency factory.</p>"},{"location":"architecture/#4-data-model","title":"4. Data Model","text":"<p>The canonical <code>VPNServer</code> model normalizes data from all providers into a single schema:</p> <pre><code>class VPNServer(BaseModel):\n    provider: Literal[\"nordvpn\", \"surfshark\"]\n    country: str              # Full country name\n    country_code: str         # ISO 3166-1 alpha-2 (e.g., \"US\")\n    identifier: str           # Hostname or connection name\n    public_key: str           # WireGuard public key\n    load: Optional[int]       # Server load 0-100% (if available)\n    latency: Optional[float]  # Measured latency in ms (if measured)\n</code></pre> <p>This normalization allows all endpoints to work identically regardless of the upstream provider.</p>"},{"location":"architecture/#data-flow","title":"Data Flow","text":""},{"location":"architecture/#server-fetch-cache-miss","title":"Server Fetch (Cache Miss)","text":"<pre><code>1. Client \u2192 GET /api/nordvpn/servers\n2. Router \u2192 NordVPNService.get_servers()\n3. aiocache: cache miss\n4. Service \u2192 httpx.AsyncClient.get(nordvpn_api_url + filters)\n5. NordVPN API \u2192 JSON response (~6000 servers)\n6. Service \u2192 _parse_nordvpn_servers():\n   - Filter: status == \"online\"\n   - Filter: WireGuard pivot.status == \"online\"\n   - Extract: hostname, public_key, load, country\n   - Sort by load (ascending)\n7. aiocache: store result (TTL from CACHE_TTL setting)\n8. Router \u2192 Apply pagination \u2192 Return JSON\n</code></pre>"},{"location":"architecture/#server-fetch-cache-hit","title":"Server Fetch (Cache Hit)","text":"<pre><code>1. Client \u2192 GET /api/nordvpn/servers\n2. Router \u2192 NordVPNService.get_servers()\n3. aiocache: cache hit \u2192 return cached List[VPNServer]\n4. Router \u2192 Apply pagination \u2192 Return JSON\n</code></pre>"},{"location":"architecture/#latency-measurement","title":"Latency Measurement","text":"<pre><code>1. Client \u2192 GET /api/nordvpn/servers/latency?method=auto&amp;limit=100\n2. Router \u2192 Fetch servers (cached) \u2192 Take first 100\n3. LatencyService.measure_servers_latency():\n   a. Extract unique hostnames\n   b. If fping available:\n      - Batch hosts (500 per batch)\n      - Execute: fping -c 1 -t 1000 -q -e &lt;hosts&gt;\n      - Parse stderr for avg latency per host\n      - Fallback to TCP if 0 successes\n   c. If TCP fallback:\n      - Semaphore(50) for concurrency control\n      - For each host: asyncio.open_connection(host, 51820)\n      - Fallback ports: 443, 80, 22\n      - Measure connection establishment time\n   d. Update VPNServer objects with latency values\n4. Router \u2192 Sort by latency \u2192 Return JSON\n</code></pre>"},{"location":"architecture/#caching-strategy","title":"Caching Strategy","text":"<p>DRACO METRIC uses <code>aiocache</code> for in-memory async caching:</p> What Cache Key TTL Invalidation All servers (per provider) Method-level (automatic) <code>CACHE_TTL</code> (default 300s) TTL expiry Servers by country <code>get_servers_by_country:{country_code}</code> <code>CACHE_TTL</code> TTL expiry <p>Cache is purely in-memory with no external dependencies. Each worker process maintains its own cache.</p> <p>Trade-offs:</p> <ul> <li>Simple, zero-dependency caching</li> <li>No shared state between workers (each worker caches independently)</li> <li>Memory scales linearly with number of workers</li> <li>For multi-instance deployments, consider adding a Redis backend</li> </ul>"},{"location":"architecture/#http-client","title":"HTTP Client","text":"<p>A single <code>httpx.AsyncClient</code> instance is shared across the application:</p> Setting Value Purpose HTTP/2 Enabled Multiplexed requests, header compression Connection pool Up to 100 connections Reuse connections to upstream APIs Keepalive 20 connections, 30s expiry Reduce connection overhead SSL verification Always enabled Never disabled, even in debug Timeouts Connect: 5s, Read: 30s, Write: 10s Fast failure on connection issues <p>The client is created during application startup (<code>lifespan</code> context manager) and closed during shutdown.</p>"},{"location":"architecture/#security-architecture","title":"Security Architecture","text":""},{"location":"architecture/#defense-in-depth","title":"Defense in Depth","text":"<pre><code>Layer 1: Reverse Proxy    \u2192 TLS termination, connection limits\nLayer 2: Rate Limiter     \u2192 Per-IP sliding window, async-safe\nLayer 3: Authentication   \u2192 API key with timing-safe comparison\nLayer 4: CORS             \u2192 Explicit origin allowlist, no wildcards\nLayer 5: Input Validation \u2192 Pydantic models, path parameter regex\nLayer 6: Error Handling   \u2192 Sanitized responses, no stack traces\nLayer 7: Response Headers \u2192 HSTS, CSP, X-Frame-Options, etc.\n</code></pre>"},{"location":"architecture/#rate-limiter-design","title":"Rate Limiter Design","text":"<p>The rate limiter uses a sliding window algorithm with <code>asyncio.Lock</code>:</p> <ul> <li>Per-IP tracking using <code>X-Forwarded-For</code> (from trusted proxies only)</li> <li>Window resets after <code>RATE_LIMIT_PERIOD</code> seconds of inactivity</li> <li>Expired entries cleaned up every 5 minutes</li> <li>Headers (<code>X-RateLimit-Limit</code>, <code>X-RateLimit-Remaining</code>, <code>X-RateLimit-Reset</code>) on every response</li> </ul>"},{"location":"architecture/#authentication","title":"Authentication","text":"<ul> <li>API keys validated with <code>secrets.compare_digest()</code> (constant-time comparison)</li> <li>Keys must be at least 32 characters</li> <li><code>/health</code>, <code>/docs</code>, <code>/redoc</code>, <code>/openapi.json</code> paths are excluded from auth</li> </ul>"},{"location":"architecture/#configuration","title":"Configuration","text":"<p>All configuration flows through <code>pydantic-settings</code>:</p> <pre><code>.env file \u2192 Environment Variables \u2192 Settings(BaseSettings) \u2192 Frozen Instance\n</code></pre> <ul> <li>Settings are immutable (<code>frozen=True</code>) after initialization</li> <li>Validated at startup with clear error messages</li> <li>Cached via <code>@lru_cache</code> (single instance per process)</li> <li>Accessed throughout the application via <code>from app.settings import settings</code></li> </ul>"},{"location":"architecture/#container-architecture","title":"Container Architecture","text":"<p>The Containerfile uses a multi-stage build:</p> <pre><code>Stage 1: Builder\n  python:3.13-slim-bookworm\n  + uv (from ghcr.io/astral-sh/uv)\n  + pyproject.toml + uv.lock\n  \u2192 /opt/venv (production deps only)\n\nStage 2: Production\n  python:3.13-slim-bookworm\n  + /opt/venv (from builder)\n  + app/ (application code)\n  + nonroot user (uid:gid 65532:65532)\n  \u2192 ENTRYPOINT: uvicorn app.main:app\n</code></pre> <p>Security features:</p> <ul> <li>Non-root user with no login shell</li> <li>No build tools in production image (no pip, no uv, no compilers)</li> <li>Production defaults baked in (<code>DEBUG=false</code>, auth enabled)</li> <li>Built-in health check polling <code>/health</code> every 30s</li> <li>~230 MB final image size</li> </ul>"},{"location":"architecture/#error-handling","title":"Error Handling","text":"<p>Exceptions are organized in a hierarchy:</p> <pre><code>Exception\n\u2514\u2500\u2500 VPNServiceError (base)\n    \u251c\u2500\u2500 VPNAPIError    \u2192 503 Service Unavailable\n    \u2514\u2500\u2500 VPNDataError   \u2192 500 Internal Server Error\n\nRequestValidationError \u2192 422 Unprocessable Entity (sanitized)\nException (catch-all)  \u2192 500 Internal Server Error (generic message)\n</code></pre> <p>All error responses follow a consistent format:</p> <pre><code>{\n  \"error\": \"Error Type\",\n  \"message\": \"User-safe description\"\n}\n</code></pre> <p>Internal details (stack traces, upstream error bodies) are logged but never exposed to clients.</p>"},{"location":"architecture/#performance-characteristics","title":"Performance Characteristics","text":"Aspect Detail JSON serialization <code>orjson</code> via <code>ORJSONResponse</code> (2-3x faster than stdlib) Response compression GZip for responses &gt; 500 bytes Connection reuse HTTP/2 multiplexing + keepalive pool Cache TTL 5 minutes (configurable 60s - 3600s) Worker restart Every 10,000 requests (prevents memory leaks) Latency measurement fping: ~2-5s for 100 servers, TCP: ~10-30s for 100 servers"},{"location":"configuration/","title":"Configuration","text":"<p>DRACO METRIC is configured via environment variables. Copy <code>.env.example</code> to <code>.env</code> and adjust the values.</p> <pre><code>cp .env.example .env\n</code></pre> <p>All settings have sensible defaults. The <code>.env</code> file is loaded automatically at startup via pydantic-settings.</p>"},{"location":"configuration/#environment-variables-reference","title":"Environment Variables Reference","text":""},{"location":"configuration/#api-urls","title":"API URLs","text":"Variable Default Description <code>NORDVPN_API_URL</code> <code>https://api.nordvpn.com/v1/servers</code> NordVPN API base URL (without query params) <code>SURFSHARK_API_URL</code> <code>https://api.surfshark.com/v3/server/clusters</code> Surfshark API endpoint <p>Note</p> <p>These are base URLs. The application appends query parameters (WireGuard filter, limit) automatically.</p>"},{"location":"configuration/#cache","title":"Cache","text":"Variable Default Range Description <code>CACHE_TTL</code> <code>300</code> 60 - 3600 Cache TTL in seconds. Server data is cached for this duration. <p>A TTL of 300 seconds (5 minutes) balances freshness with performance. Lower values increase upstream API calls; higher values serve staler data.</p>"},{"location":"configuration/#http-client","title":"HTTP Client","text":"Variable Default Range Description <code>HTTP_TIMEOUT</code> <code>30.0</code> 5.0 - 120.0 Read timeout in seconds for upstream API calls <code>HTTP_MAX_CONNECTIONS</code> <code>100</code> 10 - 500 Max concurrent connections to upstream APIs <code>HTTP_MAX_KEEPALIVE_CONNECTIONS</code> <code>20</code> 5 - 100 Max keepalive connections in the pool <p>The HTTP client uses HTTP/2, connection pooling, and always verifies SSL certificates.</p>"},{"location":"configuration/#api-limits","title":"API Limits","text":"Variable Default Range Description <code>NORDVPN_SERVER_LIMIT</code> <code>0</code> 0 - 10000 Max servers to fetch from NordVPN. <code>0</code> = unlimited (fetch all). <code>DEFAULT_PAGE_SIZE</code> <code>100</code> 10 - 500 Default items per page in paginated responses <code>MAX_PAGE_SIZE</code> <code>1000</code> 100 - 2000 Maximum allowed page size"},{"location":"configuration/#security-cors","title":"Security - CORS","text":"Variable Default Description <code>CORS_ORIGINS</code> <code>[\"http://localhost:3000\",\"http://localhost:8000\"]</code> Allowed origins (JSON array). Wildcard <code>*</code> is rejected. <code>CORS_ALLOW_CREDENTIALS</code> <code>true</code> Allow credentials in CORS requests"},{"location":"configuration/#security-authentication","title":"Security - Authentication","text":"Variable Default Description <code>ENABLE_API_KEY_AUTH</code> <code>false</code> Enable API key authentication <code>API_KEYS</code> <code>[]</code> API keys (JSON array). Each key must be &gt;= 32 characters."},{"location":"configuration/#security-rate-limiting","title":"Security - Rate Limiting","text":"Variable Default Range Description <code>RATE_LIMIT_ENABLED</code> <code>true</code> \u2014 Enable rate limiting <code>RATE_LIMIT_REQUESTS</code> <code>100</code> 10 - 10000 Requests allowed per window <code>RATE_LIMIT_PERIOD</code> <code>60</code> 10 - 3600 Window size in seconds"},{"location":"configuration/#security-headers","title":"Security - Headers","text":"Variable Default Description <code>ENABLE_SECURITY_HEADERS</code> <code>true</code> Add security headers to all responses"},{"location":"configuration/#logging","title":"Logging","text":"Variable Default Options Description <code>LOG_LEVEL</code> <code>INFO</code> <code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code>, <code>CRITICAL</code> Minimum log level <code>LOG_FORMAT</code> <code>text</code> <code>text</code>, <code>json</code> Log output format <p>Use <code>json</code> format in production for structured log parsing (ELK, Datadog, etc.):</p> <pre><code>LOG_FORMAT=json\n</code></pre> <p>Output: <pre><code>{\"time\":\"2026-01-15 12:00:00,000\",\"level\":\"INFO\",\"logger\":\"app.main\",\"message\":\"Application startup complete\"}\n</code></pre></p>"},{"location":"configuration/#application","title":"Application","text":"Variable Default Description <code>APP_NAME</code> <code>DRACO METRIC</code> Application name (shown in logs and API docs) <code>APP_VERSION</code> <code>1.0.0</code> Application version <code>DEBUG</code> <code>false</code> Enable debug mode. Never <code>true</code> in production."},{"location":"configuration/#trusted-proxies","title":"Trusted Proxies","text":"Variable Default Description <code>TRUSTED_HOSTS</code> <code>[\"127.0.0.1\",\"::1\"]</code> IPs trusted for <code>X-Forwarded-For</code> header parsing"},{"location":"configuration/#example-configurations","title":"Example Configurations","text":""},{"location":"configuration/#development","title":"Development","text":"<pre><code>DEBUG=true\nENABLE_API_KEY_AUTH=false\nRATE_LIMIT_ENABLED=true\nRATE_LIMIT_REQUESTS=1000\nLOG_LEVEL=DEBUG\nLOG_FORMAT=text\nCORS_ORIGINS=[\"http://localhost:3000\",\"http://localhost:8000\"]\n</code></pre>"},{"location":"configuration/#production","title":"Production","text":"<pre><code>DEBUG=false\nENABLE_API_KEY_AUTH=true\nAPI_KEYS=[\"your-64-char-hex-key-generated-with-openssl-rand-hex-32-here\"]\nRATE_LIMIT_ENABLED=true\nRATE_LIMIT_REQUESTS=100\nRATE_LIMIT_PERIOD=60\nLOG_LEVEL=WARNING\nLOG_FORMAT=json\nENABLE_SECURITY_HEADERS=true\nCORS_ORIGINS=[\"https://yourdomain.com\"]\nCORS_ALLOW_CREDENTIALS=false\nTRUSTED_HOSTS=[\"127.0.0.1\",\"::1\"]\nCACHE_TTL=300\n</code></pre>"},{"location":"configuration/#high-traffic-production","title":"High-Traffic Production","text":"<pre><code>DEBUG=false\nENABLE_API_KEY_AUTH=true\nAPI_KEYS=[\"key1-at-least-32-characters-long-here\",\"key2-at-least-32-characters-long-here\"]\nRATE_LIMIT_ENABLED=true\nRATE_LIMIT_REQUESTS=500\nRATE_LIMIT_PERIOD=60\nLOG_LEVEL=ERROR\nLOG_FORMAT=json\nENABLE_SECURITY_HEADERS=true\nCORS_ORIGINS=[\"https://app.example.com\",\"https://api.example.com\"]\nCACHE_TTL=600\nHTTP_MAX_CONNECTIONS=200\nHTTP_MAX_KEEPALIVE_CONNECTIONS=50\n</code></pre>"},{"location":"configuration/#validation","title":"Validation","text":"<p>All settings are validated at startup using Pydantic. If any value is out of range or invalid, the application will refuse to start with a clear error message.</p> <p>Examples of startup validation failures:</p> <pre><code>CACHE_TTL=10          \u2192 Error: value must be &gt;= 60\nAPI_KEYS=[\"short\"]    \u2192 Error: API keys must be at least 32 characters\nCORS_ORIGINS=[\"*\"]    \u2192 Error: Wildcard CORS origin '*' is not allowed\nLOG_LEVEL=VERBOSE     \u2192 Error: Invalid log level\n</code></pre>"},{"location":"installation/","title":"Installation","text":""},{"location":"installation/#requirements","title":"Requirements","text":"Requirement Version Notes Python &gt;= 3.13 Required for all features uv latest Fast Python package manager fping any (optional) For fast bulk latency measurement"},{"location":"installation/#install-from-source","title":"Install from Source","text":""},{"location":"installation/#1-clone-the-repository","title":"1. Clone the repository","text":"<pre><code>git clone https://github.com/adamantium/draco-metric.git\ncd draco-metric\n</code></pre>"},{"location":"installation/#2-install-uv-if-not-installed","title":"2. Install uv (if not installed)","text":"Linux / macOSpip <pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\n</code></pre> <pre><code>pip install uv\n</code></pre>"},{"location":"installation/#3-install-dependencies","title":"3. Install dependencies","text":"<pre><code># Production dependencies only\nuv sync --no-dev\n\n# With development dependencies (testing, linting)\nuv sync\n</code></pre> <p>This creates a <code>.venv/</code> virtual environment and installs all packages.</p>"},{"location":"installation/#4-create-configuration-file","title":"4. Create configuration file","text":"<pre><code>cp .env.example .env\n</code></pre> <p>Edit <code>.env</code> to match your environment. See Configuration for all options.</p>"},{"location":"installation/#5-verify-installation","title":"5. Verify installation","text":"<pre><code>uv run python -c \"from app.main import app; print('OK')\"\n</code></pre>"},{"location":"installation/#install-fping-optional","title":"Install fping (Optional)","text":"<p>fping enables significantly faster bulk latency measurements. Without it, the API falls back to TCP connect (which still works but is slower).</p> Debian / UbuntuFedora / RHELmacOSAlpine <pre><code>sudo apt install fping\n</code></pre> <pre><code>sudo dnf install fping\n</code></pre> <pre><code>brew install fping\n</code></pre> <pre><code>apk add fping\n</code></pre> <p>Verify: <code>fping --version</code></p>"},{"location":"installation/#project-structure","title":"Project Structure","text":"<pre><code>draco-metric/\n\u251c\u2500\u2500 app/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 main.py                 # FastAPI application entry point\n\u2502   \u251c\u2500\u2500 settings.py             # Pydantic Settings configuration\n\u2502   \u251c\u2500\u2500 middleware/\n\u2502   \u2502   \u251c\u2500\u2500 auth.py             # API key authentication\n\u2502   \u2502   \u2514\u2500\u2500 rate_limit.py       # Rate limiting\n\u2502   \u251c\u2500\u2500 models/\n\u2502   \u2502   \u2514\u2500\u2500 vpn.py              # VPNServer, CountryInfo schemas\n\u2502   \u251c\u2500\u2500 routers/\n\u2502   \u2502   \u2514\u2500\u2500 vpn.py              # API endpoint definitions\n\u2502   \u2514\u2500\u2500 services/\n\u2502       \u251c\u2500\u2500 vpn_service.py      # HTTP client + abstract base class\n\u2502       \u251c\u2500\u2500 nordvpn_service.py   # NordVPN provider implementation\n\u2502       \u251c\u2500\u2500 surfshark_service.py # Surfshark provider implementation\n\u2502       \u2514\u2500\u2500 latency_service.py   # Latency measurement (fping/TCP)\n\u251c\u2500\u2500 tests/\n\u2502   \u251c\u2500\u2500 conftest.py             # Test fixtures\n\u2502   \u251c\u2500\u2500 test_endpoints.py       # API integration tests\n\u2502   \u2514\u2500\u2500 test_services.py        # Service unit tests\n\u251c\u2500\u2500 docs/                       # This documentation\n\u251c\u2500\u2500 .env.example                # Configuration template\n\u251c\u2500\u2500 Containerfile               # Podman/Docker build\n\u251c\u2500\u2500 pyproject.toml              # Project metadata and dependencies\n\u2514\u2500\u2500 mkdocs.yml                  # Documentation config\n</code></pre>"},{"location":"installation/#development-tools","title":"Development Tools","text":""},{"location":"installation/#running-tests","title":"Running tests","text":"<pre><code>uv run pytest                   # Run all tests with coverage\nuv run pytest -v                # Verbose output\nuv run pytest tests/test_services.py  # Run specific test file\n</code></pre>"},{"location":"installation/#linting-and-formatting","title":"Linting and formatting","text":"<pre><code>uv run ruff check app/          # Lint\nuv run ruff format app/         # Format\n</code></pre>"},{"location":"installation/#starting-the-dev-server","title":"Starting the dev server","text":"<pre><code>uv run uvicorn app.main:app --reload --host 127.0.0.1 --port 8000\n</code></pre> <p>The <code>--reload</code> flag enables hot-reload on code changes.</p>"},{"location":"quickstart/","title":"Quick Start","text":"<p>Get DRACO METRIC running locally in under 2 minutes with Swagger UI and ReDoc enabled.</p>"},{"location":"quickstart/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.13+</li> <li>uv package manager</li> </ul>"},{"location":"quickstart/#steps","title":"Steps","text":""},{"location":"quickstart/#1-clone-and-install","title":"1. Clone and install","text":"<pre><code>git clone https://github.com/adamantium/draco-metric.git\ncd draco-metric\nuv sync\n</code></pre>"},{"location":"quickstart/#2-create-development-config","title":"2. Create development config","text":"<pre><code>cp .env.example .env\n</code></pre> <p>Edit <code>.env</code> and set:</p> <pre><code>DEBUG=true\nENABLE_API_KEY_AUTH=false\nRATE_LIMIT_ENABLED=true\nLOG_LEVEL=DEBUG\n</code></pre> <p>Tip</p> <p>Setting <code>DEBUG=true</code> enables <code>/docs</code> (Swagger UI), <code>/redoc</code> (ReDoc), and <code>/openapi.json</code>.</p>"},{"location":"quickstart/#3-start-the-server","title":"3. Start the server","text":"<pre><code>uv run uvicorn app.main:app --reload --host 127.0.0.1 --port 8000\n</code></pre>"},{"location":"quickstart/#4-explore-the-api","title":"4. Explore the API","text":"<p>Open your browser:</p> URL Description http://localhost:8000/docs Swagger UI (interactive) http://localhost:8000/redoc ReDoc (reference) http://localhost:8000/health Health check"},{"location":"quickstart/#5-make-your-first-request","title":"5. Make your first request","text":"<pre><code># Get NordVPN servers (first page)\ncurl http://localhost:8000/api/nordvpn/servers?page_size=5\n\n# Get Surfshark servers for Brazil\ncurl http://localhost:8000/api/surfshark/servers/BR\n\n# List available countries\ncurl http://localhost:8000/api/nordvpn/countries\n\n# Get top 5 lowest-load servers\ncurl http://localhost:8000/api/nordvpn/servers/top?limit=5\n</code></pre>"},{"location":"quickstart/#6-run-tests","title":"6. Run tests","text":"<pre><code>uv run pytest\n</code></pre>"},{"location":"quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Configuration Reference - All environment variables explained</li> <li>API Reference - Complete endpoint documentation</li> <li>Production Deployment - Deploy securely</li> </ul>"},{"location":"security/","title":"Security","text":"<p>DRACO METRIC is designed with a security-first approach. This document covers all security features, how they work, and how to configure them.</p>"},{"location":"security/#security-layers","title":"Security Layers","text":"<p>The API applies security in layers, from outermost to innermost:</p> <pre><code>Request \u2192 Rate Limiting \u2192 API Key Auth \u2192 CORS \u2192 Route Handler \u2192 Security Headers \u2192 Response\n</code></pre> <p>Each layer can be independently enabled or disabled via environment variables.</p>"},{"location":"security/#api-key-authentication","title":"API Key Authentication","text":"<p>When enabled, all <code>/api/*</code> endpoints require a valid <code>X-API-Key</code> header.</p>"},{"location":"security/#how-it-works","title":"How It Works","text":"<ol> <li>Client sends <code>X-API-Key: &lt;key&gt;</code> header with every request</li> <li>Middleware extracts the key and compares it against configured keys</li> <li>Comparison uses <code>secrets.compare_digest()</code> for constant-time comparison (prevents timing attacks)</li> <li>Invalid keys return <code>403 Forbidden</code>; missing keys return <code>401 Unauthorized</code></li> </ol>"},{"location":"security/#configuration","title":"Configuration","text":"<pre><code>ENABLE_API_KEY_AUTH=true\nAPI_KEYS=[\"your-key-here-min-32-chars-long-abcdef\"]\n</code></pre>"},{"location":"security/#generating-keys","title":"Generating Keys","text":"<pre><code># Generate a 64-character hex key\nopenssl rand -hex 32\n\n# Generate multiple keys\nfor i in 1 2 3; do openssl rand -hex 32; done\n</code></pre>"},{"location":"security/#multiple-keys","title":"Multiple Keys","text":"<p>You can configure multiple keys for key rotation or multi-tenant access:</p> <pre><code>API_KEYS=[\"key-for-service-a-min-32-chars-long\",\"key-for-service-b-min-32-chars-long\"]\n</code></pre>"},{"location":"security/#key-requirements","title":"Key Requirements","text":"<ul> <li>Minimum 32 characters (enforced at startup)</li> <li>Validated on application boot \u2014 invalid keys prevent startup</li> </ul>"},{"location":"security/#excluded-paths","title":"Excluded Paths","text":"<p>These paths are never subject to API key authentication:</p> Path Reason <code>/health</code> Load balancer health checks <code>/docs</code> Swagger UI (debug mode only) <code>/redoc</code> ReDoc (debug mode only) <code>/openapi.json</code> OpenAPI spec (debug mode only)"},{"location":"security/#usage-example","title":"Usage Example","text":"<pre><code>curl -H \"X-API-Key: your-key-here-min-32-chars-long-abcdef\" \\\n     http://localhost:8000/api/nordvpn/servers\n</code></pre>"},{"location":"security/#rate-limiting","title":"Rate Limiting","text":"<p>Protects the API from abuse using a per-IP sliding window algorithm.</p>"},{"location":"security/#how-it-works_1","title":"How It Works","text":"<ol> <li>Each client IP gets a request counter with a time window</li> <li>When the counter exceeds the limit, requests are rejected with <code>429</code></li> <li>The window slides: when the period expires, the counter resets</li> <li>Expired entries are cleaned up every 5 minutes</li> </ol>"},{"location":"security/#configuration_1","title":"Configuration","text":"<pre><code>RATE_LIMIT_ENABLED=true\nRATE_LIMIT_REQUESTS=100    # requests per window\nRATE_LIMIT_PERIOD=60       # window size in seconds\n</code></pre>"},{"location":"security/#response-headers","title":"Response Headers","text":"<p>Every response includes rate limit information:</p> <pre><code>X-RateLimit-Limit: 100\nX-RateLimit-Remaining: 95\nX-RateLimit-Reset: 1707580860\n</code></pre> <p>When rate-limited (<code>429 Too Many Requests</code>):</p> <pre><code>Retry-After: 45\nX-RateLimit-Remaining: 0\n</code></pre>"},{"location":"security/#reverse-proxy-considerations","title":"Reverse Proxy Considerations","text":"<p>Behind a reverse proxy, the rate limiter needs to know the real client IP. Configure trusted proxies:</p> <pre><code>TRUSTED_HOSTS=[\"127.0.0.1\",\"::1\",\"10.0.0.1\"]\n</code></pre> <p>The rate limiter only trusts <code>X-Forwarded-For</code> from IPs listed in <code>TRUSTED_HOSTS</code>. Direct connections from untrusted IPs use the socket IP.</p>"},{"location":"security/#excluded-paths_1","title":"Excluded Paths","text":"<p><code>/health</code>, <code>/docs</code>, <code>/redoc</code>, and <code>/openapi.json</code> are exempt from rate limiting.</p>"},{"location":"security/#scaling-note","title":"Scaling Note","text":"<p>The rate limiter uses in-memory storage. This works correctly for single-instance deployments. For multi-instance deployments behind a load balancer, consider adding a Redis-backed rate limiter or use rate limiting at the reverse proxy layer (nginx/Caddy).</p>"},{"location":"security/#security-headers","title":"Security Headers","text":"<p>When enabled, every response includes hardened HTTP headers.</p>"},{"location":"security/#configuration_2","title":"Configuration","text":"<pre><code>ENABLE_SECURITY_HEADERS=true\n</code></pre>"},{"location":"security/#headers-applied","title":"Headers Applied","text":"Header Value Purpose <code>X-Content-Type-Options</code> <code>nosniff</code> Prevents MIME type sniffing <code>X-Frame-Options</code> <code>DENY</code> Prevents clickjacking <code>Referrer-Policy</code> <code>strict-origin-when-cross-origin</code> Controls referrer leakage <code>Permissions-Policy</code> <code>geolocation=(), microphone=(), camera=()</code> Restricts browser features"},{"location":"security/#production-only-headers","title":"Production-Only Headers","text":"<p>These are added only when <code>DEBUG=false</code>:</p> Header Value Purpose <code>Strict-Transport-Security</code> <code>max-age=31536000; includeSubDomains</code> Forces HTTPS for 1 year <code>Content-Security-Policy</code> <code>default-src 'none'; frame-ancestors 'none'</code> Restricts resource loading"},{"location":"security/#server-header-removal","title":"Server Header Removal","text":"<p>The <code>Server</code> header is removed from all responses to prevent server software fingerprinting.</p>"},{"location":"security/#cors-cross-origin-resource-sharing","title":"CORS (Cross-Origin Resource Sharing)","text":"<p>Controls which origins can make requests to the API.</p>"},{"location":"security/#configuration_3","title":"Configuration","text":"<pre><code>CORS_ORIGINS=[\"https://app.example.com\",\"https://admin.example.com\"]\nCORS_ALLOW_CREDENTIALS=true\n</code></pre>"},{"location":"security/#security-rules","title":"Security Rules","text":"<ul> <li>Wildcard <code>*</code> is rejected \u2014 The application refuses to start with <code>CORS_ORIGINS=[\"*\"]</code></li> <li>Only <code>GET</code>, <code>HEAD</code>, and <code>OPTIONS</code> methods are allowed</li> <li>Only <code>X-API-Key</code>, <code>Content-Type</code>, and <code>Accept</code> headers are allowed</li> <li>Preflight responses are cached for 24 hours (<code>max_age=86400</code>)</li> </ul>"},{"location":"security/#development-config","title":"Development Config","text":"<pre><code>CORS_ORIGINS=[\"http://localhost:3000\",\"http://localhost:8000\"]\n</code></pre>"},{"location":"security/#production-config","title":"Production Config","text":"<pre><code>CORS_ORIGINS=[\"https://yourdomain.com\"]\nCORS_ALLOW_CREDENTIALS=false\n</code></pre>"},{"location":"security/#error-handling","title":"Error Handling","text":"<p>All error responses are sanitized to prevent information disclosure.</p>"},{"location":"security/#sanitization-rules","title":"Sanitization Rules","text":"Error Type What is exposed What is hidden Validation errors Field name, error type, message Stack traces, internal paths External API failures Generic \"Service Unavailable\" Provider URLs, response bodies Internal errors Generic \"Internal Server Error\" Exception details, stack traces"},{"location":"security/#exception-hierarchy","title":"Exception Hierarchy","text":"<pre><code>VPNServiceError (base)\n\u251c\u2500\u2500 VPNAPIError    \u2192 503 Service Unavailable\n\u2514\u2500\u2500 VPNDataError   \u2192 500 Internal Server Error\n\nRequestValidationError \u2192 422 Validation Error\nException (catch-all)  \u2192 500 Internal Server Error\n</code></pre>"},{"location":"security/#ssltls","title":"SSL/TLS","text":""},{"location":"security/#upstream-connections","title":"Upstream Connections","text":"<p>All outgoing HTTP requests to VPN provider APIs enforce SSL verification (<code>verify=True</code>). This cannot be disabled.</p>"},{"location":"security/#client-connections","title":"Client Connections","text":"<p>TLS termination should be handled by your reverse proxy (nginx, Caddy, or relayd). See Reverse Proxy for configuration templates.</p>"},{"location":"security/#container-security","title":"Container Security","text":"<p>The production container (see Container Deployment) includes:</p> Feature Implementation Non-root user Runs as <code>uid:gid 65532:65532</code> Read-only filesystem Application code is owned by nonroot No shell access User has <code>/usr/sbin/nologin</code> as shell Minimal image Python slim base, no build tools Health check Built-in health check endpoint Request limits Max 10,000 requests per worker before restart"},{"location":"security/#default-production-settings-in-container","title":"Default Production Settings in Container","text":"<pre><code>DEBUG=false\nENABLE_API_KEY_AUTH=true\nENABLE_SECURITY_HEADERS=true\nRATE_LIMIT_ENABLED=true\nLOG_LEVEL=WARNING\n</code></pre>"},{"location":"security/#debug-mode","title":"Debug Mode","text":"<p>Never enable debug mode in production</p> <p><code>DEBUG=true</code> exposes <code>/docs</code>, <code>/redoc</code>, <code>/openapi.json</code>, enables auto-reload, detailed error messages, and disables HSTS/CSP headers.</p>"},{"location":"security/#what-debug-mode-changes","title":"What Debug Mode Changes","text":"Feature <code>DEBUG=false</code> (production) <code>DEBUG=true</code> (development) <code>/docs</code> Disabled Enabled <code>/redoc</code> Disabled Enabled <code>/openapi.json</code> Disabled Enabled HSTS header Enabled Disabled CSP header Enabled Disabled Access logs Disabled Enabled Auto-reload Disabled Enabled"},{"location":"security/#security-checklist","title":"Security Checklist","text":"<p>Before deploying to production:</p> <ul> <li>[ ] <code>DEBUG=false</code></li> <li>[ ] <code>ENABLE_API_KEY_AUTH=true</code> with strong keys (&gt;= 32 chars)</li> <li>[ ] <code>ENABLE_SECURITY_HEADERS=true</code></li> <li>[ ] <code>RATE_LIMIT_ENABLED=true</code></li> <li>[ ] <code>CORS_ORIGINS</code> set to actual frontend domains (no wildcard)</li> <li>[ ] <code>LOG_LEVEL=WARNING</code> or <code>ERROR</code></li> <li>[ ] TLS termination configured at reverse proxy</li> <li>[ ] <code>TRUSTED_HOSTS</code> set to reverse proxy IPs only</li> <li>[ ] API keys stored securely (not in version control)</li> <li>[ ] Container running as non-root user</li> </ul>"},{"location":"deployment/container/","title":"Container Deployment","text":"<p>DRACO METRIC includes a multi-stage <code>Containerfile</code> compatible with both Podman and Docker.</p>"},{"location":"deployment/container/#building-the-image","title":"Building the Image","text":"PodmanDocker <pre><code>podman build -t draco-metric:latest -f Containerfile .\n</code></pre> <pre><code>docker build -t draco-metric:latest -f Containerfile .\n</code></pre>"},{"location":"deployment/container/#running-the-container","title":"Running the Container","text":""},{"location":"deployment/container/#basic","title":"Basic","text":"PodmanDocker <pre><code>podman run -d \\\n    --name draco-metric \\\n    -p 127.0.0.1:8000:8000 \\\n    --env-file .env \\\n    draco-metric:latest\n</code></pre> <pre><code>docker run -d \\\n    --name draco-metric \\\n    -p 127.0.0.1:8000:8000 \\\n    --env-file .env \\\n    draco-metric:latest\n</code></pre>"},{"location":"deployment/container/#with-custom-environment-variables","title":"With custom environment variables","text":"PodmanDocker <pre><code>podman run -d \\\n    --name draco-metric \\\n    -p 127.0.0.1:8000:8000 \\\n    -e DEBUG=false \\\n    -e ENABLE_API_KEY_AUTH=true \\\n    -e API_KEYS='[\"your-key-at-least-32-characters-long-here\"]' \\\n    -e LOG_LEVEL=WARNING \\\n    -e LOG_FORMAT=json \\\n    -e CORS_ORIGINS='[\"https://yourdomain.com\"]' \\\n    draco-metric:latest\n</code></pre> <pre><code>docker run -d \\\n    --name draco-metric \\\n    -p 127.0.0.1:8000:8000 \\\n    -e DEBUG=false \\\n    -e ENABLE_API_KEY_AUTH=true \\\n    -e API_KEYS='[\"your-key-at-least-32-characters-long-here\"]' \\\n    -e LOG_LEVEL=WARNING \\\n    -e LOG_FORMAT=json \\\n    -e CORS_ORIGINS='[\"https://yourdomain.com\"]' \\\n    draco-metric:latest\n</code></pre>"},{"location":"deployment/container/#with-custom-worker-count","title":"With custom worker count","text":"<p>Override the default CMD to change uvicorn options:</p> <pre><code>podman run -d \\\n    --name draco-metric \\\n    -p 127.0.0.1:8000:8000 \\\n    --env-file .env \\\n    draco-metric:latest \\\n    --host 0.0.0.0 --port 8000 --workers 4 --limit-max-requests 10000 --timeout-keep-alive 30\n</code></pre>"},{"location":"deployment/container/#container-architecture","title":"Container Architecture","text":"<p>The Containerfile uses a multi-stage build:</p>"},{"location":"deployment/container/#stage-1-builder","title":"Stage 1: Builder","text":"<ul> <li>Base: <code>python:3.13-slim-bookworm</code></li> <li>Installs <code>uv</code> for fast dependency resolution</li> <li>Creates a virtual environment at <code>/opt/venv</code></li> <li>Installs production dependencies only (no dev packages)</li> </ul>"},{"location":"deployment/container/#stage-2-production","title":"Stage 2: Production","text":"<ul> <li>Base: <code>python:3.13-slim-bookworm</code></li> <li>Copies virtual environment from builder</li> <li>Copies application code</li> <li>Runs as non-root user (<code>uid:gid 65532:65532</code>)</li> </ul>"},{"location":"deployment/container/#security-features","title":"Security Features","text":"Feature Detail Non-root user <code>nonroot</code> user with <code>uid/gid 65532</code> No login shell User shell is <code>/usr/sbin/nologin</code> Minimal image No build tools, compilers, or package managers Production defaults <code>DEBUG=false</code>, auth and security headers enabled Health check Built-in <code>HEALTHCHECK</code> instruction Request limits Workers restart after 10,000 requests"},{"location":"deployment/container/#default-environment","title":"Default Environment","text":"<p>These environment variables are set in the Containerfile (can be overridden at runtime):</p> <pre><code>DEBUG=false\nLOG_LEVEL=WARNING\nENABLE_API_KEY_AUTH=true\nENABLE_SECURITY_HEADERS=true\nRATE_LIMIT_ENABLED=true\n</code></pre>"},{"location":"deployment/container/#health-check","title":"Health Check","text":"<p>The container includes a built-in health check:</p> <pre><code>HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3\n</code></pre> <p>It polls <code>http://127.0.0.1:8000/health</code> every 30 seconds.</p> <p>Check container health:</p> PodmanDocker <pre><code>podman inspect --format='{{.State.Health.Status}}' draco-metric\n</code></pre> <pre><code>docker inspect --format='{{.State.Health.Status}}' draco-metric\n</code></pre>"},{"location":"deployment/container/#container-management","title":"Container Management","text":""},{"location":"deployment/container/#view-logs","title":"View logs","text":"<pre><code>podman logs -f draco-metric\n</code></pre>"},{"location":"deployment/container/#stop-and-remove","title":"Stop and remove","text":"<pre><code>podman stop draco-metric\npodman rm draco-metric\n</code></pre>"},{"location":"deployment/container/#restart","title":"Restart","text":"<pre><code>podman restart draco-metric\n</code></pre>"},{"location":"deployment/container/#compose-example","title":"Compose Example","text":"<p>Create <code>compose.yml</code>:</p> <pre><code>services:\n  draco-metric:\n    build:\n      context: .\n      dockerfile: Containerfile\n    container_name: draco-metric\n    ports:\n      - \"127.0.0.1:8000:8000\"\n    env_file:\n      - .env\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD\", \"python\", \"-c\", \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=3)\"]\n      interval: 30s\n      timeout: 5s\n      retries: 3\n      start_period: 10s\n</code></pre> <p>Run:</p> PodmanDocker <pre><code>podman compose up -d\n</code></pre> <pre><code>docker compose up -d\n</code></pre>"},{"location":"deployment/container/#image-size","title":"Image Size","text":"<p>The multi-stage build produces a minimal image. Approximate sizes:</p> Component Size Base image (python:3.13-slim) ~150 MB Virtual environment ~80 MB Application code &lt; 1 MB Total ~230 MB"},{"location":"deployment/development/","title":"Development Setup","text":"<p>Complete guide to setting up a local development environment.</p>"},{"location":"deployment/development/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.13+</li> <li>uv package manager</li> <li>Git</li> <li>fping (optional, for latency measurements)</li> </ul>"},{"location":"deployment/development/#setup","title":"Setup","text":""},{"location":"deployment/development/#1-clone-and-install","title":"1. Clone and install","text":"<pre><code>git clone https://github.com/adamantium/draco-metric.git\ncd draco-metric\nuv sync\n</code></pre>"},{"location":"deployment/development/#2-configure-environment","title":"2. Configure environment","text":"<pre><code>cp .env.example .env\n</code></pre> <p>Edit <code>.env</code> for development:</p> <pre><code># Enable interactive API docs\nDEBUG=true\n\n# Disable auth for local development\nENABLE_API_KEY_AUTH=false\n\n# Verbose logging\nLOG_LEVEL=DEBUG\nLOG_FORMAT=text\n\n# Keep rate limiting but with higher threshold\nRATE_LIMIT_ENABLED=true\nRATE_LIMIT_REQUESTS=1000\n\n# Local CORS origins\nCORS_ORIGINS=[\"http://localhost:3000\",\"http://localhost:8000\"]\n</code></pre>"},{"location":"deployment/development/#3-start-the-server","title":"3. Start the server","text":"<pre><code>uv run uvicorn app.main:app --reload --host 127.0.0.1 --port 8000\n</code></pre> <p>The <code>--reload</code> flag watches for file changes and restarts automatically.</p> <p>You should see:</p> <pre><code>INFO - Starting DRACO METRIC v1.0.0\nINFO - HTTP client initialized with HTTP/2 and connection pooling\nINFO - Application startup complete\nINFO:     Uvicorn running on http://127.0.0.1:8000\n</code></pre>"},{"location":"deployment/development/#4-verify","title":"4. Verify","text":"<pre><code>curl http://localhost:8000/health\n</code></pre> <p>Expected response:</p> <pre><code>{\"status\": \"healthy\", \"version\": \"1.0.0\"}\n</code></pre>"},{"location":"deployment/development/#5-explore-the-api","title":"5. Explore the API","text":"<p>With <code>DEBUG=true</code>, interactive documentation is available:</p> <ul> <li>Swagger UI: http://localhost:8000/docs</li> <li>ReDoc: http://localhost:8000/redoc</li> </ul>"},{"location":"deployment/development/#running-tests","title":"Running Tests","text":"<pre><code># All tests with coverage report\nuv run pytest\n\n# Verbose output\nuv run pytest -v\n\n# Specific test file\nuv run pytest tests/test_services.py\n\n# Specific test\nuv run pytest tests/test_services.py::test_nordvpn_filters_offline_servers\n</code></pre> <p>Coverage report is written to <code>htmlcov/</code> \u2014 open <code>htmlcov/index.html</code> in a browser.</p>"},{"location":"deployment/development/#linting","title":"Linting","text":"<pre><code># Check for issues\nuv run ruff check app/ tests/\n\n# Auto-fix issues\nuv run ruff check --fix app/ tests/\n\n# Format code\nuv run ruff format app/ tests/\n</code></pre>"},{"location":"deployment/development/#useful-development-requests","title":"Useful Development Requests","text":"<pre><code># NordVPN servers (first 5)\ncurl -s http://localhost:8000/api/nordvpn/servers?page_size=5 | python -m json.tool\n\n# Surfshark servers for US\ncurl -s http://localhost:8000/api/surfshark/servers/US | python -m json.tool\n\n# Available countries\ncurl -s http://localhost:8000/api/nordvpn/countries | python -m json.tool\n\n# Top 3 servers by load\ncurl -s \"http://localhost:8000/api/nordvpn/servers/top?limit=3\" | python -m json.tool\n\n# Measure latency (TCP, 10 servers)\ncurl -s \"http://localhost:8000/api/nordvpn/servers/latency?limit=10&amp;method=tcp\" | python -m json.tool\n\n# Find fastest server\ncurl -s \"http://localhost:8000/api/nordvpn/servers/fastest?limit=1\" | python -m json.tool\n</code></pre>"},{"location":"deployment/development/#testing-with-api-key-auth","title":"Testing with API Key Auth","text":"<p>To test authentication locally:</p> <pre><code># Generate a test key\nKEY=$(openssl rand -hex 32)\necho \"Generated key: $KEY\"\n</code></pre> <p>Update <code>.env</code>:</p> <pre><code>ENABLE_API_KEY_AUTH=true\nAPI_KEYS=[\"&lt;paste-your-key-here&gt;\"]\n</code></pre> <p>Restart the server, then:</p> <pre><code># This should fail (401)\ncurl http://localhost:8000/api/nordvpn/servers\n\n# This should work\ncurl -H \"X-API-Key: $KEY\" http://localhost:8000/api/nordvpn/servers\n</code></pre>"},{"location":"deployment/production/","title":"Production Deployment","text":"<p>Complete guide to deploying DRACO METRIC in production.</p>"},{"location":"deployment/production/#overview","title":"Overview","text":"<p>A production deployment consists of:</p> <pre><code>Internet \u2192 Reverse Proxy (TLS) \u2192 DRACO METRIC (uvicorn) \u2192 Upstream APIs\n</code></pre> <p>The reverse proxy handles TLS termination, static file serving, and connection management. DRACO METRIC handles the application logic.</p>"},{"location":"deployment/production/#option-1-direct-python-deployment","title":"Option 1: Direct Python Deployment","text":""},{"location":"deployment/production/#1-install-dependencies","title":"1. Install dependencies","text":"<pre><code>git clone https://github.com/adamantium/draco-metric.git\ncd draco-metric\nuv sync --no-dev\n</code></pre>"},{"location":"deployment/production/#2-create-production-configuration","title":"2. Create production configuration","text":"<pre><code>cp .env.example .env\nchmod 600 .env\n</code></pre> <p>Edit <code>.env</code>:</p> <pre><code>DEBUG=false\nENABLE_API_KEY_AUTH=true\nAPI_KEYS=[\"&lt;generate-with-openssl-rand-hex-32&gt;\"]\nENABLE_SECURITY_HEADERS=true\nRATE_LIMIT_ENABLED=true\nRATE_LIMIT_REQUESTS=100\nRATE_LIMIT_PERIOD=60\nLOG_LEVEL=WARNING\nLOG_FORMAT=json\nCORS_ORIGINS=[\"https://yourdomain.com\"]\nCORS_ALLOW_CREDENTIALS=false\nTRUSTED_HOSTS=[\"127.0.0.1\",\"::1\"]\n</code></pre>"},{"location":"deployment/production/#3-start-with-uvicorn","title":"3. Start with uvicorn","text":"<pre><code>uv run uvicorn app.main:app \\\n    --host 127.0.0.1 \\\n    --port 8000 \\\n    --workers 2 \\\n    --limit-max-requests 10000 \\\n    --timeout-keep-alive 30 \\\n    --log-level warning\n</code></pre> Flag Purpose <code>--host 127.0.0.1</code> Bind to localhost only (reverse proxy handles external traffic) <code>--workers 2</code> Number of worker processes (adjust per CPU cores) <code>--limit-max-requests 10000</code> Restart workers after 10K requests (prevents memory leaks) <code>--timeout-keep-alive 30</code> Keepalive timeout in seconds"},{"location":"deployment/production/#4-systemd-service-linux","title":"4. Systemd service (Linux)","text":"<p>Create <code>/etc/systemd/system/draco-metric.service</code>:</p> <pre><code>[Unit]\nDescription=DRACO METRIC API\nAfter=network.target\n\n[Service]\nType=exec\nUser=dracometric\nGroup=dracometric\nWorkingDirectory=/opt/draco-metric\nEnvironmentFile=/opt/draco-metric/.env\nExecStart=/opt/draco-metric/.venv/bin/uvicorn app.main:app \\\n    --host 127.0.0.1 \\\n    --port 8000 \\\n    --workers 2 \\\n    --limit-max-requests 10000 \\\n    --timeout-keep-alive 30 \\\n    --log-level warning\nRestart=always\nRestartSec=5\n\n# Security hardening\nNoNewPrivileges=true\nProtectSystem=strict\nProtectHome=true\nReadWritePaths=/opt/draco-metric\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Enable and start:</p> <pre><code>sudo useradd --system --shell /usr/sbin/nologin dracometric\nsudo systemctl daemon-reload\nsudo systemctl enable --now draco-metric\nsudo systemctl status draco-metric\n</code></pre>"},{"location":"deployment/production/#option-2-container-deployment","title":"Option 2: Container Deployment","text":"<p>See Container Deployment for Podman/Docker deployment.</p>"},{"location":"deployment/production/#reverse-proxy","title":"Reverse Proxy","text":"<p>See Reverse Proxy for nginx, Caddy, and OpenBSD relayd templates.</p>"},{"location":"deployment/production/#workers","title":"Workers","text":"<p>The number of workers depends on your use case:</p> Workload Recommended Workers Reasoning Low traffic 2 Minimal resource usage Moderate traffic 4 Good balance High traffic CPU cores * 2 + 1 Uvicorn recommendation <p>Since DRACO METRIC is I/O-bound (waiting on upstream APIs and network latency), more workers help with concurrent requests.</p>"},{"location":"deployment/production/#health-checks","title":"Health Checks","text":"<p>The <code>/health</code> endpoint returns <code>200 OK</code> with:</p> <pre><code>{\"status\": \"healthy\", \"version\": \"1.0.0\"}\n</code></pre> <p>Use this for:</p> <ul> <li>Load balancer health checks</li> <li>Container orchestration (built into the Containerfile)</li> <li>Monitoring systems (uptime checks)</li> </ul>"},{"location":"deployment/production/#logging","title":"Logging","text":""},{"location":"deployment/production/#json-logs-recommended-for-production","title":"JSON logs (recommended for production)","text":"<pre><code>LOG_FORMAT=json\nLOG_LEVEL=WARNING\n</code></pre> <p>Output: <pre><code>{\"time\":\"2026-01-15 12:00:00\",\"level\":\"WARNING\",\"logger\":\"app.middleware.rate_limit\",\"message\":\"Rate limit exceeded for 1.2.3.4 on /api/nordvpn/servers (101/100)\"}\n</code></pre></p>"},{"location":"deployment/production/#log-levels-for-production","title":"Log levels for production","text":"Level Use Case <code>WARNING</code> Default \u2014 logs rate limits, auth failures, parse errors <code>ERROR</code> Minimal \u2014 only errors and exceptions <code>INFO</code> Verbose \u2014 includes startup, API calls, cache hits"},{"location":"deployment/production/#monitoring","title":"Monitoring","text":"<p>Key metrics to monitor:</p> What How Application health Poll <code>/health</code> every 30s Response times Reverse proxy access logs Error rate Count <code>5xx</code> responses in logs Rate limit hits Count <code>429</code> responses or <code>WARNING</code> logs Auth failures Count <code>401</code>/<code>403</code> responses Upstream availability Count <code>503</code> responses (VPN API unreachable)"},{"location":"deployment/production/#security-checklist","title":"Security Checklist","text":"<p>Before going live:</p> <ul> <li>[ ] <code>DEBUG=false</code></li> <li>[ ] <code>ENABLE_API_KEY_AUTH=true</code> with keys &gt;= 32 characters</li> <li>[ ] <code>ENABLE_SECURITY_HEADERS=true</code></li> <li>[ ] <code>RATE_LIMIT_ENABLED=true</code></li> <li>[ ] <code>CORS_ORIGINS</code> restricted to your domains</li> <li>[ ] <code>TRUSTED_HOSTS</code> set to proxy IPs</li> <li>[ ] <code>.env</code> file has <code>chmod 600</code> (owner-only read)</li> <li>[ ] TLS configured at reverse proxy</li> <li>[ ] Running as non-root user</li> <li>[ ] <code>LOG_FORMAT=json</code> for structured logging</li> <li>[ ] Firewall: only port 443 exposed externally</li> <li>[ ] uvicorn binds to <code>127.0.0.1</code> (not <code>0.0.0.0</code>)</li> </ul>"},{"location":"deployment/reverse-proxy/","title":"Reverse Proxy Configuration","text":"<p>DRACO METRIC should run behind a reverse proxy that handles TLS termination, connection management, and optionally rate limiting.</p> <p>The application binds to <code>127.0.0.1:8000</code> by default. The reverse proxy listens on ports 80/443 and forwards requests.</p> <pre><code>Client \u2192 [443/TLS] \u2192 Reverse Proxy \u2192 [8000/HTTP] \u2192 DRACO METRIC\n</code></pre> <p>Important</p> <p>Configure <code>TRUSTED_HOSTS</code> in <code>.env</code> to include your reverse proxy's IP so that rate limiting uses the real client IP from <code>X-Forwarded-For</code>.</p> <pre><code>TRUSTED_HOSTS=[\"127.0.0.1\",\"::1\"]\n</code></pre>"},{"location":"deployment/reverse-proxy/#nginx","title":"Nginx","text":""},{"location":"deployment/reverse-proxy/#basic-configuration","title":"Basic Configuration","text":"<pre><code>upstream draco_metric {\n    server 127.0.0.1:8000;\n    keepalive 32;\n}\n\nserver {\n    listen 80;\n    server_name api.example.com;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name api.example.com;\n\n    # TLS\n    ssl_certificate     /etc/ssl/certs/api.example.com.pem;\n    ssl_certificate_key /etc/ssl/private/api.example.com.key;\n    ssl_protocols       TLSv1.2 TLSv1.3;\n    ssl_ciphers         HIGH:!aNULL:!MD5;\n    ssl_prefer_server_ciphers on;\n    ssl_session_cache   shared:SSL:10m;\n    ssl_session_timeout 1d;\n\n    # Security headers (additional to what DRACO METRIC adds)\n    add_header X-Content-Type-Options \"nosniff\" always;\n    add_header X-Frame-Options \"DENY\" always;\n\n    # Proxy settings\n    location / {\n        proxy_pass http://draco_metric;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header Connection \"\";\n\n        # Timeouts\n        proxy_connect_timeout 5s;\n        proxy_read_timeout 60s;\n        proxy_send_timeout 10s;\n\n        # Buffering\n        proxy_buffering on;\n        proxy_buffer_size 4k;\n        proxy_buffers 8 4k;\n    }\n\n    # Block access to debug endpoints in production\n    location ~ ^/(docs|redoc|openapi\\.json)$ {\n        return 404;\n    }\n\n    # Health check passthrough\n    location /health {\n        proxy_pass http://draco_metric;\n        access_log off;\n    }\n}\n</code></pre>"},{"location":"deployment/reverse-proxy/#with-nginx-rate-limiting","title":"With Nginx Rate Limiting","text":"<p>If you need rate limiting at the proxy level (e.g., multi-instance deployment):</p> <pre><code># Define rate limit zone (10 req/s per IP, 10MB shared memory)\nlimit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;\n\nserver {\n    # ... TLS config as above ...\n\n    location / {\n        limit_req zone=api_limit burst=20 nodelay;\n        limit_req_status 429;\n\n        proxy_pass http://draco_metric;\n        # ... proxy settings as above ...\n    }\n}\n</code></pre>"},{"location":"deployment/reverse-proxy/#caddy","title":"Caddy","text":"<p>Caddy provides automatic HTTPS via Let's Encrypt.</p>"},{"location":"deployment/reverse-proxy/#caddyfile","title":"Caddyfile","text":"<pre><code>api.example.com {\n    # Reverse proxy to DRACO METRIC\n    reverse_proxy 127.0.0.1:8000 {\n        header_up X-Forwarded-For {remote_host}\n        header_up X-Forwarded-Proto {scheme}\n\n        # Health checks\n        health_uri /health\n        health_interval 30s\n        health_timeout 5s\n    }\n\n    # Block debug endpoints\n    @debug path /docs /redoc /openapi.json\n    respond @debug 404\n\n    # Compression\n    encode gzip\n\n    # Access log\n    log {\n        output file /var/log/caddy/draco-metric.log\n        format json\n    }\n}\n</code></pre>"},{"location":"deployment/reverse-proxy/#with-rate-limiting","title":"With Rate Limiting","text":"<p>Caddy supports rate limiting via the <code>rate_limit</code> directive (requires the rate limit module):</p> <pre><code>api.example.com {\n    rate_limit {remote.ip} 100r/m\n\n    reverse_proxy 127.0.0.1:8000 {\n        header_up X-Forwarded-For {remote_host}\n        header_up X-Forwarded-Proto {scheme}\n    }\n}\n</code></pre>"},{"location":"deployment/reverse-proxy/#running-caddy","title":"Running Caddy","text":"<pre><code># With Caddyfile in current directory\ncaddy run\n\n# Or as a systemd service\nsudo systemctl enable --now caddy\n</code></pre> <p>Caddy automatically obtains and renews TLS certificates from Let's Encrypt.</p>"},{"location":"deployment/reverse-proxy/#openbsd-relayd","title":"OpenBSD relayd","text":""},{"location":"deployment/reverse-proxy/#relaydconf","title":"relayd.conf","text":"<pre><code># Macros\next_addr = \"egress\"\ndraco_addr = \"127.0.0.1\"\ndraco_port = \"8000\"\n\n# HTTP redirect to HTTPS\nhttp protocol \"http_redirect\" {\n    return code 301 location \"https://$HOST$REQUEST_URI\"\n}\n\n# HTTPS protocol definition\nhttp protocol \"https_draco\" {\n    # TLS configuration\n    tls { no tlsv1.0, no tlsv1.1, ciphers \"HIGH:!aNULL:!MD5\" }\n\n    # Pass headers\n    match request header append \"X-Forwarded-For\" value \"$REMOTE_ADDR\"\n    match request header append \"X-Forwarded-Proto\" value \"https\"\n\n    # Block debug endpoints\n    match request path \"/docs\" forward to &lt;blocked&gt;\n    match request path \"/redoc\" forward to &lt;blocked&gt;\n    match request path \"/openapi.json\" forward to &lt;blocked&gt;\n\n    # Health check\n    match request path \"/health\" forward to &lt;draco&gt;\n}\n\n# Relay definitions\nrelay \"http_redirect\" {\n    listen on $ext_addr port 80\n    protocol \"http_redirect\"\n    forward to &lt;draco&gt; port $draco_port\n}\n\nrelay \"https_draco\" {\n    listen on $ext_addr port 443 tls\n    protocol \"https_draco\"\n    forward to &lt;draco&gt; port $draco_port check http \"/health\" code 200\n}\n\n# Tables\ntable &lt;draco&gt; { $draco_addr }\ntable &lt;blocked&gt; disable\n</code></pre>"},{"location":"deployment/reverse-proxy/#tls-certificates","title":"TLS Certificates","text":"<p>Place your certificates:</p> <pre><code># Certificate\n/etc/ssl/api.example.com.pem\n\n# Private key\n/etc/ssl/private/api.example.com.key\n</code></pre> <p>Or use <code>acme-client(1)</code> for Let's Encrypt:</p> <pre><code># /etc/acme-client.conf\nauthority letsencrypt {\n    api url \"https://acme-v02.api.letsencrypt.org/directory\"\n    account key \"/etc/acme/letsencrypt-privkey.pem\"\n}\n\ndomain api.example.com {\n    domain key \"/etc/ssl/private/api.example.com.key\"\n    domain full chain certificate \"/etc/ssl/api.example.com.pem\"\n    sign with letsencrypt\n}\n</code></pre>"},{"location":"deployment/reverse-proxy/#enable-and-start","title":"Enable and start","text":"<pre><code>rcctl enable relayd\nrcctl start relayd\n</code></pre>"},{"location":"deployment/reverse-proxy/#verify","title":"Verify","text":"<pre><code>rcctl check relayd\nrelayctl show relays\n</code></pre>"},{"location":"deployment/reverse-proxy/#common-configuration","title":"Common Configuration","text":"<p>Regardless of which reverse proxy you use, ensure:</p> <ol> <li><code>TRUSTED_HOSTS</code> in <code>.env</code> includes your proxy's IP</li> <li><code>X-Forwarded-For</code> header is set by the proxy</li> <li>TLS 1.2+ is enforced</li> <li>uvicorn binds to <code>127.0.0.1</code> (not <code>0.0.0.0</code>)</li> <li>Debug endpoints (<code>/docs</code>, <code>/redoc</code>, <code>/openapi.json</code>) are blocked at the proxy level as a defense-in-depth measure (they are already disabled when <code>DEBUG=false</code>)</li> <li><code>/health</code> endpoint is accessible for monitoring without auth</li> </ol>"}]}